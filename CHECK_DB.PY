import sqlite3
import os
from datetime import datetime, timezone, timedelta

def format_taiwan_time(time_str):
    """æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º"""
    try:
        # è§£ææ™‚é–“å­—ä¸²
        dt = datetime.fromisoformat(time_str.replace('Z', '+00:00'))
        # è½‰æ›ç‚ºå°ç£æ™‚é–“é¡¯ç¤º
        taiwan_tz = timezone(timedelta(hours=8))
        taiwan_time = dt.astimezone(taiwan_tz)
        return taiwan_time.strftime('%Y-%m-%d %H:%M:%S (UTC+8)')
    except:
        return time_str

def check_database():
    db_path = "app.db"
    
    if not os.path.exists(db_path):
        print("âŒ è³‡æ–™åº«æª”æ¡ˆä¸å­˜åœ¨ï¼Œè«‹å…ˆå•Ÿå‹• FastAPI æ‡‰ç”¨ç¨‹å¼")
        return
    
    print("âœ… æ‰¾åˆ°è³‡æ–™åº«æª”æ¡ˆ")
    
    # é€£æ¥è³‡æ–™åº«
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    print("\n" + "="*60)
    print("ğŸ“Š è³‡æ–™åº«å…§å®¹æª¢æŸ¥ (æ™‚é–“é¡¯ç¤ºç‚º UTC+8)")
    print("="*60)
    
    # æŸ¥çœ‹æ‰€æœ‰è³‡æ–™è¡¨
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
    tables = cursor.fetchall()
    print(f"ğŸ“‹ è³‡æ–™è¡¨: {[table[0] for table in tables]}")
    
    # æŸ¥çœ‹ç”¨æˆ¶è³‡æ–™
    print(f"\nğŸ‘¥ ç”¨æˆ¶è³‡æ–™è¡¨ (users):")
    print("-" * 40)
    try:
        cursor.execute("SELECT id, email, is_active FROM users;")
        users = cursor.fetchall()
        if users:
            for user in users:
                print(f"ID: {user[0]} | Email: {user[1]} | å•Ÿç”¨: {user[2]}")
        else:
            print("ğŸ“ ç›®å‰æ²’æœ‰ç”¨æˆ¶è³‡æ–™")
        print(f"ç¸½è¨ˆ: {len(users)} å€‹ç”¨æˆ¶")
    except Exception as e:
        print(f"âŒ è®€å–ç”¨æˆ¶è³‡æ–™å¤±æ•—: {e}")
    
    # æŸ¥çœ‹é©—è­‰ç¢¼è³‡æ–™
    print(f"\nğŸ” é©—è­‰ç¢¼è³‡æ–™è¡¨ (verification_codes):")
    print("-" * 50)
    try:
        cursor.execute("SELECT email, code, created_at, is_used FROM verification_codes ORDER BY created_at DESC;")
        codes = cursor.fetchall()
        if codes:
            for code in codes:
                formatted_time = format_taiwan_time(code[2]) if code[2] else "æœªçŸ¥æ™‚é–“"
                print(f"Email: {code[0]}")
                print(f"é©—è­‰ç¢¼: {code[1]}")
                print(f"å»ºç«‹æ™‚é–“: {formatted_time}")
                print(f"å·²ä½¿ç”¨: {code[3]}")
                print("-" * 30)
        else:
            print("ğŸ“ ç›®å‰æ²’æœ‰é©—è­‰ç¢¼è³‡æ–™")
        print(f"ç¸½è¨ˆ: {len(codes)} å€‹é©—è­‰ç¢¼")
    except Exception as e:
        print(f"âŒ è®€å–é©—è­‰ç¢¼å¤±æ•—: {e}")
    
    conn.close()
    print("="*60)

if __name__ == "__main__":
    check_database()